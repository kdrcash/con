<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pro-Consulting Lab (HTML/JS)</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- SheetJS (Excel Export) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    .sticky-col-1 {
      left: 0;
      z-index: 20;
      box-shadow: 2px 0 5px -2px rgba(0,0,0,0.1);
    }
    .sticky-col-2 {
      left: 40px;
      z-index: 20;
      box-shadow: 2px 0 5px -2px rgba(0,0,0,0.1);
    }
    .table-container { overflow-x: auto; }
    .sticky-col { position: sticky; }
  </style>

  <script>
    // =========================================================
    // 0) API ì„¤ì • (AWS Lambda ì—°ê²°)
    // =========================================================
    const API_BASE = "https://dgrfavjoudnkjfbibm3k3sinfy0wzdmw.lambda-url.us-east-1.on.aws";

    // =========================================================
    // 1) ì„¤ì • ë° ìƒìˆ˜ (Configuration)
    // =========================================================
    const CONFIG_SIM = {
      year: 2025,

      // Lambda CONFIG.nationalPension (ê·¼ë¡œì ë¶€ë‹´ë¥ )
      nationalPension: {
        employeeRate: 0.0450,
      },

      // Lambda CONFIG.healthInsurance (ê·¼ë¡œì ë¶€ë‹´ë¥  + ì¥ê¸°ìš”ì–‘(ê±´ë³´ì˜ 12.95%))
      healthInsurance: {
        employeeRate: 0.03545,
        ltcRateOnHI: 0.1295,
      },

      // Lambda CONFIG.progressiveTax (Quick Deduction)
      progressiveTax: [
        { upto: 14_000_000,    rate: 0.06, quickDeduction: 0 },
        { upto: 50_000_000,    rate: 0.15, quickDeduction: 1_260_000 },
        { upto: 88_000_000,    rate: 0.24, quickDeduction: 5_760_000 },
        { upto: 150_000_000,   rate: 0.35, quickDeduction: 15_440_000 },
        { upto: 300_000_000,   rate: 0.38, quickDeduction: 19_940_000 },
        { upto: 500_000_000,   rate: 0.40, quickDeduction: 25_940_000 },
        { upto: 1_000_000_000, rate: 0.42, quickDeduction: 35_940_000 },
        { upto: null,          rate: 0.45, quickDeduction: 65_940_000 },
      ],
    };

    // API ìƒíƒœ í‘œì‹œìš©
    const API_STATUS = {
      state: "idle", // idle | checking | ok | error
      message: "ì—°ê²° í™•ì¸ ì „",
      meta: null,
      health: null,
      lastCheckedAt: null
    };

    const EMPTY_INPUTS = {
      annualRevenue: 0, monthlyExpense: 0, monthlyRequiredExpense: 0,
      targetProfitRate: 0, afterTaxNetIncome: 0,
    };

    const INPUT_FIELDS = [
      { name: 'annualRevenue', isCurrency: true, resultName: 'annualRev' },
      { name: 'monthlyExpense', isCurrency: true, resultName: 'monthlyExp' },
      { name: 'monthlyRequiredExpense', isCurrency: true, resultName: 'monthlyReqExp' },
      { name: 'targetProfitRate', isCurrency: false, resultName: 'targetProfitRate' },
      { name: 'afterTaxNetIncome', isCurrency: true, resultName: 'monthlyNetIncome' }
    ];

    const DASHBOARD_CONFIG = {
      'mode1': [
        { title: "ì˜ˆìƒ ë§¤ì¶œ", keyAnn: 'annualRev', keyMon: 'monthlyRev', icon: 'TrendingUp', color: 'bg-emerald-500' },
        { title: "ì˜ˆìƒ ì„¸í›„ìˆœì´ìµ", keyAnn: 'annualNetIncome', keyMon: 'monthlyNetIncome', icon: 'DollarSign', color: 'bg-blue-500' }
      ],
      'mode2': [
        { title: "ì˜ˆìƒ ë§¤ì¶œ", keyAnn: 'annualRev', keyMon: 'monthlyRev', icon: 'TrendingUp', color: 'bg-emerald-500' },
        { title: "ëª©í‘œì†Œë“ë¥ ", keyVal: 'targetProfitRate', isPercent: true, icon: 'Target', color: 'bg-purple-500' }
      ],
      'mode3': [
        { title: "ì˜ˆìƒ ë§¤ì¶œ", keyAnn: 'annualRev', keyMon: 'monthlyRev', icon: 'TrendingUp', color: 'bg-emerald-500' },
        { title: "í•„ìš”ê²½ë¹„", keyAnn: 'annualReqExp', keyMon: 'monthlyReqExp', icon: 'Calculator', color: 'bg-orange-500' }
      ],
      'mode4': [
        { title: "í•„ìš”ê²½ë¹„", keyAnn: 'annualReqExp', keyMon: 'monthlyReqExp', icon: 'Calculator', color: 'bg-orange-500' },
        { title: "ì˜ˆìƒ ì„¸í›„ìˆœì´ìµ", keyAnn: 'annualNetIncome', keyMon: 'monthlyNetIncome', icon: 'DollarSign', color: 'bg-blue-500' }
      ],
      'mode5': [
        { title: "í•„ìš”ê²½ë¹„", keyAnn: 'annualReqExp', keyMon: 'monthlyReqExp', icon: 'Calculator', color: 'bg-orange-500' },
        { title: "ëª©í‘œì†Œë“ë¥ ", keyVal: 'targetProfitRate', isPercent: true, icon: 'Target', color: 'bg-purple-500' }
      ]
    };

    const SIMULATION_MODES = [
      { id: 'mode1', label: '1. ì—°ë§¤ì¶œ & ì„¸í›„ìˆœì´ìµ ì‚°ì¶œ', desc: 'ì›”ì§€ì¶œ/ì›”í•„ìš”ê²½ë¹„/ëª©í‘œì†Œë“ë¥ ì„ ê¸°ë°˜ìœ¼ë¡œ ì—°ë§¤ì¶œ/ìˆœì´ìµì„ ì—­ì‚°í•©ë‹ˆë‹¤.', icon: 'ğŸ“ˆ' },
      { id: 'mode2', label: '2. ì—°ë§¤ì¶œ & ëª©í‘œì†Œë“ë¥  ì‚°ì¶œ', desc: 'í•„ìš”ê²½ë¹„/ì§€ì¶œ/ì„¸í›„ìˆœì´ìµ ê¸°ë°˜ìœ¼ë¡œ ëª©í‘œì†Œë“ë¥ /ë§¤ì¶œì„ ì—­ì‚°í•©ë‹ˆë‹¤.', icon: 'ğŸ“Š' },
      { id: 'mode3', label: '3. ì—°ë§¤ì¶œ & í•„ìš”ê²½ë¹„ ì‚°ì¶œ', desc: 'ì§€ì¶œ/ëª©í‘œì†Œë“ë¥ /ì„¸í›„ìˆœì´ìµ ê¸°ë°˜ìœ¼ë¡œ í•„ìš”ê²½ë¹„/ë§¤ì¶œì„ ì—­ì‚°í•©ë‹ˆë‹¤.', icon: 'ğŸ§®' },
      { id: 'mode4', label: '4. í•„ìš”ê²½ë¹„ & ì„¸í›„ìˆœì´ìµ ì‚°ì¶œ', desc: 'ì—°ë§¤ì¶œ/ì§€ì¶œ/ëª©í‘œì†Œë“ë¥  ê¸°ë°˜ìœ¼ë¡œ í•„ìš”ê²½ë¹„/ì„¸í›„ìˆœì´ìµì„ ì‚°ì¶œí•©ë‹ˆë‹¤.', icon: 'ğŸ’°' },
      { id: 'mode5', label: '5. í•„ìš”ê²½ë¹„ & ëª©í‘œì†Œë“ë¥  ì‚°ì¶œ', desc: 'ì—°ë§¤ì¶œ/ì§€ì¶œ/ì„¸í›„ìˆœì´ìµ ê¸°ë°˜ìœ¼ë¡œ í•„ìš”ê²½ë¹„/ëª©í‘œì†Œë“ë¥ ì„ ì—­ì‚°í•©ë‹ˆë‹¤.', icon: 'ğŸ¯' }
    ];

    const ICON_MAP = {
      'TrendingUp': 'ğŸ“ˆ', 'PieChart': 'ğŸ“Š', 'Calculator': 'ğŸ§®',
      'DollarSign': 'ğŸ’°', 'Target': 'ğŸ¯', 'Activity': 'ğŸ’¡',
      'FileText': 'ğŸ“„', 'RotateCcw': 'ğŸ”„', 'Plus': 'â•',
      'Trash2': 'ğŸ—‘ï¸', 'Save': 'ğŸ’¾', 'ArrowRightCircle': 'â¡ï¸'
    };

    // =========================================================
    // 2) ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    // =========================================================
    const formatCurrency = (val) => new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(val);

    const formatCompactCurrency = (val) => {
      if (!val) return '0';
      return new Intl.NumberFormat('ko-KR', { style: 'decimal', maximumFractionDigits: 0 }).format(val);
    };

    const validate = (val) => Number.isFinite(val) ? val : 0;

    const formatRate = (rate) => {
      const numericRate = parseFloat(rate);
      return (Number.isFinite(numericRate) ? numericRate : 0).toFixed(1);
    };

    const toPercent = (num) => (Number.isFinite(num) ? num.toFixed(1) : '0.0');

    // âœ… ëŒë‹¤ì‹ ì ˆì‚¬(10ì› ë¯¸ë§Œ ì ˆì‚¬)
    const trunc10 = (v) => Math.floor((Number(v) || 0) / 10) * 10;

    const clamp = (x, lo, hi) => Math.min(Math.max(x, lo), hi);

    function numOr(v, fallback) {
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    }

    // =========================================================
    // 3) (Lambda ê¸°ì¤€) ì¢…í•©ì†Œë“ì„¸ ëˆ„ì§„ì„¸ìœ¨ ê³„ì‚° (Quick Deduction)
    // =========================================================
    function calculateProgressiveIncomeTax(tb) {
      const base = Math.max(0, Math.floor(Number(tb) || 0));
      for (const s of CONFIG_SIM.progressiveTax) {
        if (s.upto === null || base <= s.upto) {
          const tax = Math.floor(base * s.rate - s.quickDeduction);
          return Math.max(0, tax);
        }
      }
      return 0;
    }

    // =========================================================
    // 4) ëª©í‘œê°’ ì°¾ê¸° (Binary Search)
    // =========================================================
    const solveBinarySearch = (func, targetValue) => {
      let low = 0;
      let high = 100_000_000_000; // 1000ì–µ
      let mid = 0;

      for (let i = 0; i < 100; i++) {
        mid = (low + high) / 2;
        const result = func(mid);

        if (Math.abs(result - targetValue) < 10) break;
        if (result < targetValue) low = mid;
        else high = mid;
      }
      return mid;
    };

    // =========================================================
    // âœ… 5) ë³´í—˜ ê³„ì‚°(ëŒë‹¤ /meta ë°˜ì˜)
    //   - ë³´ìˆ˜ì›”ì•¡ = ì†Œë“ê¸ˆì•¡/12
    //   - êµ­ë¯¼ì—°ê¸ˆ: 1,000ì› ë‹¨ìœ„ ì ˆì‚¬ í›„ ìƒ/í•˜í•œ ì ìš©, 10ì› ì ˆì‚¬
    //   - ê±´ê°•ë³´í—˜: ë³´ìˆ˜ì›”ì•¡ ìƒ/í•˜í•œ ì ìš©, 10ì› ì ˆì‚¬
    //   - ì¥ê¸°ìš”ì–‘: ê±´ë³´ë£Œ Ã— ltcRateOnHI, 10ì› ì ˆì‚¬
    //   - ì‚¬ì—…ì£¼: ê·¼ë¡œì ë¶€ë‹´ë¥ ì˜ 2ë°°(= employeeRate*2)
    // =========================================================
    function getInsuranceMetaFromLambda() {
      // ëŒë‹¤ /metaê°€ ë³´í†µ { year, ranges: { np:{min,max}, hi:{min,max} }, ... } í˜•íƒœë¼ê³  ê°€ì •
      const meta = API_STATUS.meta || {};
      const ranges = meta.ranges || {};

      const npMin = numOr(ranges?.np?.min, null);
      const npMax = numOr(ranges?.np?.max, null);
      const hiMin = numOr(ranges?.hi?.min, null);
      const hiMax = numOr(ranges?.hi?.max, null);

      // ìš”ìœ¨ì€ metaì— ìˆìœ¼ë©´ ìš°ì„ , ì—†ìœ¼ë©´ CONFIG_SIM ì‚¬ìš©
      const npEmployeeRate = numOr(meta?.np?.employeeRate, CONFIG_SIM.nationalPension.employeeRate);
      const hiEmployeeRate = numOr(meta?.hi?.employeeRate, CONFIG_SIM.healthInsurance.employeeRate);
      const ltcRateOnHI    = numOr(meta?.hi?.ltcRateOnHI, CONFIG_SIM.healthInsurance.ltcRateOnHI);

      return {
        year: numOr(meta?.year, CONFIG_SIM.year),
        np: {
          min: Number.isFinite(npMin) ? npMin : null,
          max: Number.isFinite(npMax) ? npMax : null,
          employeeRate: npEmployeeRate
        },
        hi: {
          min: Number.isFinite(hiMin) ? hiMin : null,
          max: Number.isFinite(hiMax) ? hiMax : null,
          employeeRate: hiEmployeeRate,
          ltcRateOnHI
        }
      };
    }

    function calcInsuranceByLambdaRules(annualIncomeAmount) {
      const m = getInsuranceMetaFromLambda();

      const monthlyBaseRaw = Math.max(0, Number(annualIncomeAmount || 0) / 12);

      // êµ­ë¯¼ì—°ê¸ˆ: 1,000ì› ì ˆì‚¬ í›„ clamp(ìƒ/í•˜í•œì´ metaì— ì—†ìœ¼ë©´ "clamp ìƒëµ" ëŒ€ì‹  raw ì‚¬ìš©)
      let npBase = Math.floor(monthlyBaseRaw / 1000) * 1000;
      if (Number.isFinite(m.np.min) && Number.isFinite(m.np.max)) {
        npBase = clamp(npBase, m.np.min, m.np.max);
      }

      // ê±´ê°•ë³´í—˜: raw clamp
      let hiBase = monthlyBaseRaw;
      if (Number.isFinite(m.hi.min) && Number.isFinite(m.hi.max)) {
        hiBase = clamp(hiBase, m.hi.min, m.hi.max);
      }

      // âœ… ì‚¬ì—…ì£¼: 2ë°°
      const npRateTotal = (Number(m.np.employeeRate) || 0) * 2;
      const hiRateTotal = (Number(m.hi.employeeRate) || 0) * 2;

      const monthlyNP  = trunc10(npBase * npRateTotal);
      const monthlyHI  = trunc10(hiBase * hiRateTotal);
      const monthlyLTC = trunc10(monthlyHI * (Number(m.hi.ltcRateOnHI) || 0));

      return {
        monthlyBaseRaw,
        npBase, hiBase,
        monthlyNP, annualNP: monthlyNP * 12,
        monthlyHI, monthlyLTC,
        annualHI: monthlyHI * 12,
        annualLTC: monthlyLTC * 12,
        monthlyInsuranceTotal: monthlyHI + monthlyLTC,
        annualInsuranceTotal: (monthlyHI + monthlyLTC) * 12,
      };
    }

    // =========================================================
    // 6) í•µì‹¬ ê³„ì‚° ë¡œì§ (Core Calculation)
    // =========================================================
    const calculateResults = (inputs, mode) => {
      const { annualRevenue, monthlyExpense, monthlyRequiredExpense, targetProfitRate, afterTaxNetIncome } = inputs;

      const annualExp = monthlyExpense * 12;
      const annualReqExpInput = monthlyRequiredExpense * 12;
      const annualAfterTaxNetIncome = afterTaxNetIncome * 12;

      let calcAR = annualRevenue;
      let calcMRE = monthlyRequiredExpense;
      let calcTPR = targetProfitRate;

      let actualNetIncome = 0; // ANI
      let taxBaseIncome = 0;   // TNI (ê³¼ì„¸í‘œì¤€ ê°€ì •)

      switch (mode) {
        case 'mode1': {
          const totalExpense = annualExp + annualReqExpInput;
          const complement = 1 - targetProfitRate / 100;
          calcAR = (complement > 0 && targetProfitRate < 100) ? totalExpense / complement : 0;

          actualNetIncome = calcAR - annualExp;
          taxBaseIncome = actualNetIncome - annualReqExpInput;
          calcMRE = monthlyRequiredExpense;
          calcTPR = targetProfitRate;
          break;
        }
        case 'mode2': {
          const func = (tni) => {
            const incomeTax = calculateProgressiveIncomeTax(tni);
            const totalTax = incomeTax * 1.1;
            const ani = tni + annualReqExpInput;
            return ani - totalTax;
          };
          taxBaseIncome = solveBinarySearch(func, annualAfterTaxNetIncome);

          calcAR = taxBaseIncome + annualReqExpInput + annualExp;
          actualNetIncome = calcAR - annualExp;
          calcTPR = (calcAR !== 0) ? (taxBaseIncome / calcAR) * 100 : 0;
          calcMRE = monthlyRequiredExpense;
          break;
        }
        case 'mode3': {
          const tprRatio = targetProfitRate / 100;
          if (tprRatio > 0) {
            const func = (tni) => {
              const incomeTax = calculateProgressiveIncomeTax(tni);
              const totalTax = incomeTax * 1.1;
              const ar = tni / tprRatio;
              const ani = ar - annualExp;
              return ani - totalTax;
            };
            taxBaseIncome = solveBinarySearch(func, annualAfterTaxNetIncome);
            calcAR = taxBaseIncome / tprRatio;
            actualNetIncome = calcAR - annualExp;
            calcMRE = (actualNetIncome - taxBaseIncome) / 12;
          } else {
            calcAR = 0; calcMRE = 0; taxBaseIncome = 0; actualNetIncome = 0;
          }
          calcTPR = targetProfitRate;
          break;
        }
        case 'mode4': {
          actualNetIncome = annualRevenue - annualExp;
          taxBaseIncome = annualRevenue * (targetProfitRate / 100);
          calcMRE = (actualNetIncome - taxBaseIncome) / 12;
          calcAR = annualRevenue;
          calcTPR = targetProfitRate;
          break;
        }
        case 'mode5': {
          actualNetIncome = annualRevenue - annualExp;
          const targetTaxBurden = actualNetIncome - annualAfterTaxNetIncome;

          if (targetTaxBurden > 0) {
            const func = (tni) => calculateProgressiveIncomeTax(tni) * 1.1;
            taxBaseIncome = solveBinarySearch(func, targetTaxBurden);
          } else {
            taxBaseIncome = actualNetIncome;
          }
          calcMRE = (actualNetIncome - taxBaseIncome) / 12;
          calcTPR = (annualRevenue !== 0) ? (taxBaseIncome / annualRevenue) * 100 : 0;
          calcAR = annualRevenue;
          break;
        }
      }

      // ìµœì¢… ê°’ ë³´ì •
      const finalAR  = validate(calcAR);
      const finalMRE = validate(calcMRE);
      const finalTPR = validate(calcTPR);
      const finalANI = validate(actualNetIncome);
      const finalTNI = validate(taxBaseIncome);

      // âœ… ì„¸ê¸ˆ(ì¢…í•©ì†Œë“ì„¸Â·ì§€ë°©ì„¸)
      const incomeTax = calculateProgressiveIncomeTax(finalTNI);
      const totalTax  = incomeTax * 1.1;

      // âœ… ë³´í—˜(ëŒë‹¤ /meta ìƒí•˜í•œ + ì ˆì‚¬ ê·œì¹™ ë°˜ì˜) + ì‚¬ì—…ì£¼(2ë°°)
      const ins = calcInsuranceByLambdaRules(finalTNI);

      // ì„¸í›„ ìˆœì´ìµ
      const finalATNI = validate(finalANI - totalTax);

      // ì‹¤ì œ ì†Œë“ë¥  (ANI / AR)
      const actualPR = (finalAR !== 0) ? (finalANI / finalAR) * 100 : 0;

      // ë§¤ì¶œëŒ€ë¹„ ì„¸ê¸ˆë¹„ìœ¨(ì—°ë§¤ì¶œ ëŒ€ë¹„ ì—°ê°„ ì¢…í•©ì†Œë“ì„¸Â·ì§€ë°©ì„¸)
      const annualTaxRate = (finalAR !== 0) ? (totalTax / finalAR) * 100 : 0;

      // âœ… ì†Œë“ê¸ˆì•¡(ì¹´í…Œê³ ë¦¬ ì¶”ê°€: ì‹¤ì œ/ëª©í‘œ)
      const annualIncomeAmountActual = validate(finalAR * (validate(actualPR) / 100));
      const annualIncomeAmountTarget = validate(finalAR * (finalTPR / 100));

      return {
        annualRev: finalAR,
        monthlyRev: finalAR / 12,

        annualExp: annualExp,
        monthlyExp: monthlyExpense,

        annualReqExp: finalMRE * 12,
        monthlyReqExp: finalMRE,

        // âœ… ì†Œë“ê¸ˆì•¡(ì—°ê°„) - ì‹¤ì œ/ëª©í‘œ
        annualIncomeAmountActual,
        annualIncomeAmountTarget,

        actualProfitRate: validate(actualPR),
        targetProfitRate: finalTPR,

        annualNetIncome: finalATNI,
        monthlyNetIncome: finalATNI / 12,

        annualTax: totalTax,
        monthlyTax: totalTax / 12,
        annualTaxRate: validate(annualTaxRate),

        // âœ… êµ­ë¯¼ì—°ê¸ˆ/ê±´ê°•ë³´í—˜ë£Œ: "í˜„ì¬ í‘œê¸°ëœ ê¸ˆì•¡ì˜ 2ë°°" ìš”êµ¬ ë°˜ì˜ ì™„ë£Œ(ìœ„ ë³´í—˜ ê³„ì‚°ì—ì„œ ì´ë¯¸ 2ë°° ì ìš©)
        annualPension: validate(ins.annualNP),
        monthlyPension: validate(ins.monthlyNP),

        annualInsurance: validate(ins.annualInsuranceTotal),
        monthlyInsurance: validate(ins.monthlyInsuranceTotal),
      };
    };

    // =========================================================
    // 7) ìƒíƒœ ê´€ë¦¬
    // =========================================================
    let state = {
      calculationMode: 'mode1',
      inputs: { ...EMPTY_INPUTS },
      lastCalculatedResults: calculateResults(EMPTY_INPUTS, 'mode1'),
      scenarios: [],
      domRefs: {}
    };

    const isInputDisabled = (fieldName) => {
      const m = state.calculationMode;
      if (m === 'mode1') return fieldName === 'annualRevenue' || fieldName === 'afterTaxNetIncome';
      if (m === 'mode2') return fieldName === 'annualRevenue' || fieldName === 'targetProfitRate';
      if (m === 'mode3') return fieldName === 'annualRevenue' || fieldName === 'monthlyRequiredExpense';
      if (m === 'mode4') return fieldName === 'monthlyRequiredExpense' || fieldName === 'afterTaxNetIncome';
      if (m === 'mode5') return fieldName === 'monthlyRequiredExpense' || fieldName === 'targetProfitRate';
      return false;
    };

    // =========================================================
    // 8) UI ë Œë”
    // =========================================================
    const createCard = (title, val1, val2, isPercent, iconKey, color) => {
      const icon = ICON_MAP[iconKey] || iconKey;
      const v1 = isPercent ? (val1?.toFixed(1) || '0.0') + '%' : (typeof val1 === 'number' ? formatCurrency(Math.round(val1)) : val1);
      const v2 = isPercent ? null : (typeof val2 === 'number' ? formatCurrency(Math.round(val2)) : val2);
      return `
        <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200 relative overflow-hidden">
          <div class="absolute top-0 right-0 p-2 rounded-bl-xl opacity-10 ${color}">${icon}</div>
          <h4 class="text-sm font-bold text-slate-500 mb-3 flex items-center gap-2">
            <span class="text-slate-400">${icon}</span> ${title}
            <span class="text-xs font-normal text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full">ì‚°ì¶œê°’</span>
          </h4>
          <div class="space-y-3">
            <div class="flex justify-between items-end border-b border-slate-100 pb-2">
              <span class="text-xs text-slate-400">${isPercent ? 'ë¹„ìœ¨' : 'ì—°ê°„'}</span>
              <span class="text-lg font-bold text-slate-800">${v1}</span>
            </div>
            ${v2 ? `
              <div class="flex justify-between items-end">
                <span class="text-xs text-slate-400">ì›”ê°„</span>
                <span class="text-lg font-bold text-slate-800">${v2}</span>
              </div>
            ` : ''}
          </div>
        </div>`;
    };

    const createFixedResultCard = (title, value1Label, value1, value2Label, value2, iconKey, colorText="text-slate-800") => {
      const icon = ICON_MAP[iconKey] || iconKey;
      if (title === 'ì†Œë“ë¥ ') {
        return `
          <div class="bg-slate-50 rounded-xl p-5 border border-slate-200">
            <h4 class="text-sm font-bold text-slate-500 mb-3 flex items-center gap-2">
              <span>${icon}</span> ${title}
              <span class="text-xs font-normal text-slate-400 bg-slate-200 px-2 py-0.5 rounded-full">ê³ ì •</span>
            </h4>
            <div class="space-y-3">
              <div class="flex justify-between items-center border-b border-slate-100 pb-2">
                <span class="text-xs text-slate-400">ì‹¤ì œì†Œë“ë¥ </span>
                <span class="text-lg font-bold text-slate-800">${value1}</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-xs text-slate-400">ëª©í‘œì†Œë“ë¥ </span>
                <span class="text-lg font-bold text-slate-800">${value2}</span>
              </div>
            </div>
          </div>`;
      }
      return `
        <div class="bg-slate-50 rounded-xl p-5 border border-slate-200">
          <h4 class="text-sm font-bold text-slate-500 mb-3 flex items-center gap-2">
            <span class="text-slate-400">${icon}</span> ${title}
            <span class="text-xs font-normal text-slate-400 bg-slate-200 px-2 py-0.5 rounded-full">ê³ ì •</span>
          </h4>
          <div class="space-y-3">
            <div class="flex justify-between items-center border-b border-slate-100 pb-2">
              <span class="text-xs text-slate-400">${value1Label}</span>
              <span class="text-lg font-bold ${colorText}">${value1}</span>
            </div>
            ${value2Label ? `
              <div class="flex justify-between items-center">
                <span class="text-xs text-slate-400">${value2Label}</span>
                <span class="text-lg font-bold ${colorText}">${value2}</span>
              </div>
            ` : ''}
          </div>
        </div>`;
    };

    function renderApiStatusBadge() {
      const el = state.domRefs.apiStatusBadge;
      const sub = state.domRefs.apiStatusSub;

      if (!el || !sub) return;

      const s = API_STATUS.state;
      const msg = API_STATUS.message;

      const cls =
        s === "ok" ? "bg-emerald-50 text-emerald-700 border-emerald-200" :
        s === "checking" ? "bg-amber-50 text-amber-700 border-amber-200" :
        s === "error" ? "bg-red-50 text-red-700 border-red-200" :
        "bg-slate-50 text-slate-600 border-slate-200";

      el.className = `text-xs font-semibold px-3 py-1.5 rounded-full border ${cls} flex items-center gap-2`;
      el.innerHTML = `
        <span class="inline-block h-2 w-2 rounded-full ${s==="ok"?"bg-emerald-500":s==="checking"?"bg-amber-500":s==="error"?"bg-red-500":"bg-slate-400"}"></span>
        API ${s === "ok" ? "ì—°ê²°ë¨" : s === "checking" ? "í™•ì¸ì¤‘" : s === "error" ? "ì˜¤ë¥˜" : "ëŒ€ê¸°"}
      `;

      const year = API_STATUS.meta?.year ?? CONFIG_SIM.year;
      const taxTableReady = API_STATUS.health?.taxTableReady;
      const taxTableTxt = (typeof taxTableReady === "boolean") ? (taxTableReady ? "ì„¸ì•¡í‘œ OK" : "ì„¸ì•¡í‘œ ì—†ìŒ(í´ë°±)") : "ì„¸ì•¡í‘œ ?";

      const checked = API_STATUS.lastCheckedAt ? new Date(API_STATUS.lastCheckedAt).toLocaleString() : "-";
      sub.textContent = `${msg} Â· year=${year} Â· ${taxTableTxt} Â· ${checked}`;
    }

    const renderDashboard = () => {
      const res = state.lastCalculatedResults;
      const config = DASHBOARD_CONFIG[state.calculationMode] || DASHBOARD_CONFIG['mode1'];

      const cardsHtml = config.map(c => {
        const annualVal = c.isPercent ? res[c.keyVal] : res[c.keyAnn];
        const monthlyVal = c.isPercent ? 0 : res[c.keyMon];
        return createCard(c.title, annualVal, monthlyVal, c.isPercent, c.icon, c.color);
      }).join('');

      const actRate = `${formatRate(res.actualProfitRate)}%`;
      const tgtRate = `${formatRate(res.targetProfitRate)}%`;
      const industryAvg = 40;
      const diff = industryAvg - res.actualProfitRate;
      const diffText = diff > 0 ? 'ë‚®ìŠµë‹ˆë‹¤' : 'ë†’ìŠµë‹ˆë‹¤';

      const fixedCardsHtml = `
        ${createFixedResultCard("ì†Œë“ë¥ ", null, actRate, null, tgtRate, "PieChart")}
        ${createFixedResultCard("ì¢…í•©ì†Œë“ì„¸Â·ì§€ë°©ì„¸", "ì—°ê°„", formatCurrency(res.annualTax), "ì›”ê°„", formatCurrency(res.monthlyTax), "FileText")}
      `;

      state.domRefs.dashboardCards.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${cardsHtml}</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${fixedCardsHtml}</div>
      `;

      const modeLabel = SIMULATION_MODES.find(m => m.id === state.calculationMode)?.label || '';
      state.domRefs.dashboardInsightMode.textContent = modeLabel.split('.')[1]?.trim() || modeLabel;
      state.domRefs.dashboardInsightText.innerHTML =
        `í˜„ì¬ ì†Œë“ë¥ (<strong>${actRate}</strong>)ì€ ë™ì¢… ì—…ê³„ í‰ê· (${industryAvg}%) ëŒ€ë¹„ <strong>${Math.abs(diff).toFixed(1)}%</strong> ${diffText}.<br/>
         í•„ìš”ê²½ë¹„ë¥¼ <strong>â‚©${formatCompactCurrency(res.monthlyReqExp)}</strong>ìœ¼ë¡œ ìœ ì§€í•  ê²½ìš°, ëª©í‘œ ì†Œë“ë¥  ë‹¬ì„±ì„ ìœ„í•´ ì—°ë§¤ì¶œ <strong>â‚©${formatCompactCurrency(res.annualRev)}</strong>ì´ í•„ìš”í•©ë‹ˆë‹¤.`;
    };

    const updateInputForm = () => {
      const inputs = state.inputs;
      const results = state.lastCalculatedResults;

      INPUT_FIELDS.forEach(field => {
        const input = document.querySelector(`[name="${field.name}"]`);
        const disabled = isInputDisabled(field.name);
        const label = input.closest('div.space-y-5 > div').querySelector('label span');

        input.className = `w-full px-4 py-2.5 rounded-lg border transition-colors ${
          disabled
            ? 'bg-slate-100 border-slate-200 text-slate-400 cursor-not-allowed'
            : 'bg-white border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
        }`;
        input.placeholder = disabled ? "ìë™ ê³„ì‚°" : "0";
        if (label) label.style.display = disabled ? 'inline' : 'none';

        let val = disabled ? results[field.resultName] : inputs[field.name];

        if (document.activeElement !== input || disabled) {
          if (field.name === 'targetProfitRate') {
            input.value = Number.isFinite(val) ? val.toFixed(2) : '0.00';
          } else {
            const num = Math.round(val);
            input.value = Number.isFinite(num) ? num.toLocaleString() : '0';
          }
        }
      });
    };

    const renderModeSelectors = () => {
      state.domRefs.modeSelectors.innerHTML = SIMULATION_MODES.map(mode => {
        const isActive = state.calculationMode === mode.id;
        const activeClass = isActive ? 'border-blue-600 bg-blue-50 ring-2 ring-blue-100 ring-offset-2 shadow-md' : 'border-slate-200 bg-white hover:border-blue-300 hover:bg-blue-50/30';
        const iconClass = isActive ? 'bg-blue-200 text-blue-700' : 'bg-slate-100 text-slate-500 group-hover:bg-blue-100 group-hover:text-blue-600';
        const labelClass = isActive ? 'text-blue-700' : 'text-slate-700';
        const indicator = isActive ? '<div class="h-2 w-2 rounded-full bg-blue-600 animate-pulse mt-1"></div>' : '';
        return `
          <button onclick="setCalculationMode('${mode.id}')" class="mode-btn relative p-4 rounded-xl border-2 text-left transition-all group ${activeClass}" data-mode="${mode.id}">
            <div class="flex justify-between items-start mb-2">
              <div class="flex items-center gap-2">
                <div class="p-1.5 rounded-lg ${iconClass}">${mode.icon}</div>
                <span class="font-bold text-sm ${labelClass}">${mode.label}</span>
              </div>
              ${indicator}
            </div>
            <p class="text-xs text-slate-500 pl-9">${mode.desc}</p>
          </button>`;
      }).join('');
    };

    const renderScenarioTable = () => {
      const tbody = state.domRefs.scenarioTableBody;
      if (state.scenarios.length === 0) {
        tbody.innerHTML = `<tr><td colspan="23" class="px-6 py-12 text-center text-slate-400 bg-slate-50/30">ì…ë ¥ í›„ ğŸ§® ê³„ì‚°í•˜ê¸°ë¥¼ ëˆŒëŸ¬ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.</td></tr>`;
        return;
      }

      tbody.innerHTML = state.scenarios.map((item, idx) => {
        const netRatio = item.annualRev ? ((item.annualNetIncome / item.annualRev) * 100).toFixed(1) : '0.0';
        const taxRatio = item.annualRev ? ((item.annualTax / item.annualRev) * 100).toFixed(1) : '0.0';
        return `
          <tr class="hover:bg-slate-50/80 transition-colors">
            <td class="px-3 py-3 text-center font-medium text-slate-400 border-r border-slate-100 sticky sticky-col sticky-col-1 bg-white z-10">${idx + 1}</td>
            <td class="px-4 py-3 text-center border-r border-slate-100 sticky sticky-col sticky-col-2 bg-white z-10">
              <span class="px-2 py-0.5 rounded-full text-[10px] font-medium bg-slate-100 text-slate-600 truncate block w-24 mx-auto">${item.mode.split('.')[0]} ì‹œë‚˜ë¦¬ì˜¤</span>
            </td>

            <td class="px-4 py-3 text-center text-blue-700 font-bold bg-blue-50/30 border-r border-slate-100">${item.actualProfitRate.toFixed(1)}%</td>
            <td class="px-4 py-3 text-center text-blue-600 bg-blue-50/30 border-r border-slate-100">${item.targetProfitRate.toFixed(1)}%</td>

            <td class="px-2 py-3 text-right text-slate-700 font-medium bg-slate-50/30 border-r border-slate-100">${formatCompactCurrency(item.annualRev)}</td>
            <td class="px-2 py-3 text-right text-slate-700 bg-slate-50/30 border-r border-slate-100">${formatCompactCurrency(item.monthlyRev)}</td>

            <td class="px-2 py-3 text-right text-slate-700 bg-slate-100/50 border-r border-slate-100">${formatCompactCurrency(item.annualExp)}</td>
            <td class="px-2 py-3 text-right text-slate-700 bg-slate-100/50 border-r border-slate-100">${formatCompactCurrency(item.monthlyExp)}</td>

            <td class="px-2 py-3 text-right text-slate-700 bg-slate-100/50 border-r border-slate-100">${formatCompactCurrency(item.annualReqExp)}</td>
            <td class="px-2 py-3 text-right text-slate-700 bg-slate-100/50 border-r border-slate-100">${formatCompactCurrency(item.monthlyReqExp)}</td>

            <!-- âœ… ì†Œë“ê¸ˆì•¡(ì¹´í…Œê³ ë¦¬) ì‹¤ì œ/ëª©í‘œ -->
            <td class="px-2 py-3 text-right text-slate-700 bg-slate-50/30 border-r border-slate-100">${formatCompactCurrency(item.annualIncomeAmountActual)}</td>
            <td class="px-2 py-3 text-right text-slate-700 bg-slate-50/30 border-r border-slate-100">${formatCompactCurrency(item.annualIncomeAmountTarget)}</td>

            <td class="px-2 py-3 text-right font-bold text-blue-700 bg-blue-50/30 border-r border-slate-100">${formatCompactCurrency(item.annualNetIncome)}</td>
            <td class="px-2 py-3 text-right font-bold text-blue-700 bg-blue-50/30 border-r border-slate-100">${formatCompactCurrency(item.monthlyNetIncome)}</td>
            <td class="px-2 py-3 text-center font-bold text-blue-600 bg-blue-50/30 border-r border-slate-100">${netRatio}%</td>

            <td class="px-2 py-3 text-right text-slate-500 border-r border-slate-100">${formatCompactCurrency(item.annualTax)}</td>
            <td class="px-2 py-3 text-right text-slate-500 border-r border-slate-100">${formatCompactCurrency(item.monthlyTax)}</td>
            <td class="px-2 py-3 text-center text-slate-500 border-r border-slate-100">${taxRatio}%</td>

            <td class="px-2 py-3 text-right text-slate-500 border-r border-slate-100">${formatCompactCurrency(item.annualPension)}</td>
            <td class="px-2 py-3 text-right text-slate-500 border-r border-slate-100">${formatCompactCurrency(item.monthlyPension)}</td>

            <td class="px-2 py-3 text-right text-slate-500 border-r border-slate-100">${formatCompactCurrency(item.annualInsurance)}</td>
            <td class="px-2 py-3 text-right text-slate-500 border-r border-slate-100">${formatCompactCurrency(item.monthlyInsurance)}</td>

            <td class="px-3 py-3 text-center">
              <button class="remove-btn text-slate-400 hover:text-red-500 transition-colors p-1" data-id="${item.id}">ğŸ—‘ï¸</button>
            </td>
          </tr>`;
      }).join('');
    };

    const exportScenariosToExcel = () => {
      if (!window.XLSX || !state.scenarios.length) {
        alert('ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤.');
        return;
      }

      const header = [
        'No', 'êµ¬ë¶„(ëª¨ë“œ)',
        'ì‹¤ì œì†Œë“ë¥ (%)', 'ëª©í‘œì†Œë“ë¥ (%)',
        'ì—°ë§¤ì¶œ', 'ì›”ë§¤ì¶œ',
        'ì—°ì§€ì¶œ', 'ì›”ì§€ì¶œ',
        'ì—°í•„ìš”ê²½ë¹„', 'ì›”í•„ìš”ê²½ë¹„',
        'ì†Œë“ê¸ˆì•¡(ì‹¤ì œ)', 'ì†Œë“ê¸ˆì•¡(ëª©í‘œ)',
        'ì—°ì„¸í›„ìˆœì´ìµ', 'ì›”ì„¸í›„ìˆœì´ìµ', 'ì„¸í›„ìˆœì´ìµë¹„ìœ¨(%)',
        'ì—°ì¢…í•©ì†Œë“ì„¸Â·ì§€ë°©ì„¸', 'ì›”ì¢…í•©ì†Œë“ì„¸Â·ì§€ë°©ì„¸', 'ì„¸ê¸ˆë¹„ìœ¨(ì—°ë§¤ì¶œëŒ€ë¹„, %)',
        'ì—°êµ­ë¯¼ì—°ê¸ˆ', 'ì›”êµ­ë¯¼ì—°ê¸ˆ',
        'ì—°ê±´ê°•ë³´í—˜ë£Œ(ê±´ë³´+ì¥ê¸°ìš”ì–‘)', 'ì›”ê±´ê°•ë³´í—˜ë£Œ(ê±´ë³´+ì¥ê¸°ìš”ì–‘)'
      ];

      const rows = state.scenarios.map((s, i) => {
        const netRatio = s.annualRev ? ((s.annualNetIncome / s.annualRev) * 100) : 0;
        const taxRatio = s.annualRev ? ((s.annualTax / s.annualRev) * 100) : 0;
        return [
          i + 1,
          s.mode,
          Number(formatRate(s.actualProfitRate)),
          Number(formatRate(s.targetProfitRate)),
          Math.round(s.annualRev), Math.round(s.monthlyRev),
          Math.round(s.annualExp), Math.round(s.monthlyExp),
          Math.round(s.annualReqExp), Math.round(s.monthlyReqExp),
          Math.round(s.annualIncomeAmountActual), Math.round(s.annualIncomeAmountTarget),
          Math.round(s.annualNetIncome), Math.round(s.monthlyNetIncome),
          Number(toPercent(netRatio)),
          Math.round(s.annualTax), Math.round(s.monthlyTax), Number(toPercent(taxRatio)),
          Math.round(s.annualPension), Math.round(s.monthlyPension),
          Math.round(s.annualInsurance), Math.round(s.monthlyInsurance),
        ];
      });

      const ws = XLSX.utils.aoa_to_sheet([header, ...rows]);

      ws['!cols'] = [
        { wch: 5 }, { wch: 24 },
        { wch: 14 }, { wch: 14 },
        { wch: 14 }, { wch: 14 },
        { wch: 14 }, { wch: 14 },
        { wch: 14 }, { wch: 14 },
        { wch: 16 }, { wch: 16 },
        { wch: 16 }, { wch: 16 }, { wch: 18 },
        { wch: 20 }, { wch: 20 }, { wch: 22 },
        { wch: 14 }, { wch: 14 },
        { wch: 22 }, { wch: 22 },
      ];

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Scenarios');

      const now = new Date();
      const filename = `Pro-Consulting-Scenarios_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}.xlsx`;
      XLSX.writeFile(wb, filename);
    };

    // =========================================================
    // 9) API ì—°ê²° í™•ì¸ (health/meta)
    // =========================================================
    async function checkApiConnection() {
      API_STATUS.state = "checking";
      API_STATUS.message = "Lambda health/meta í™•ì¸ì¤‘";
      API_STATUS.lastCheckedAt = Date.now();
      renderApiStatusBadge();

      try {
        const [healthRes, metaRes] = await Promise.all([
          fetch(`${API_BASE}/health`, { method: "GET" }),
          fetch(`${API_BASE}/meta`, { method: "GET" })
        ]);

        if (!healthRes.ok || !metaRes.ok) {
          throw new Error(`http_error (health=${healthRes.status}, meta=${metaRes.status})`);
        }

        const health = await healthRes.json();
        const meta = await metaRes.json();

        API_STATUS.health = health;
        API_STATUS.meta = meta;

        API_STATUS.state = "ok";
        API_STATUS.message = "Lambda ì‘ë‹µ ì •ìƒ";
        API_STATUS.lastCheckedAt = Date.now();

        if (meta?.year && Number(meta.year)) {
          CONFIG_SIM.year = Number(meta.year);
        }

      } catch (e) {
        API_STATUS.state = "error";
        API_STATUS.message = "Lambda ì—°ê²° ì‹¤íŒ¨(ë„ë©”ì¸/CORS/ê²½ë¡œ í™•ì¸)";
        API_STATUS.lastCheckedAt = Date.now();
      }

      renderApiStatusBadge();

      // âœ… meta ê°±ì‹  í›„ ê³„ì‚°ê°’ë„ ì¦‰ì‹œ ë°˜ì˜(ìƒ/í•˜í•œì´ ë°”ë€Œë¯€ë¡œ)
      state.lastCalculatedResults = calculateResults(state.inputs, state.calculationMode);
      renderDashboard();
      renderScenarioTable();
    }

    // =========================================================
    // 10) ì´ë²¤íŠ¸/ì´ˆê¸°í™”
    // =========================================================
    const setCalculationMode = (modeId) => {
      state.calculationMode = modeId;
      state.lastCalculatedResults = calculateResults(state.inputs, state.calculationMode);
      updateInputForm();
      renderModeSelectors();
      renderDashboard();
    };

    const handleInput = (e) => {
      const { name, value, type } = e.target;

      let rawValue;
      if (type === 'text' && ['annualRevenue','monthlyExpense','monthlyRequiredExpense','afterTaxNetIncome'].includes(name)) {
        rawValue = Number(value.replace(/,/g, ''));
      } else if (type === 'number' || name === 'targetProfitRate') {
        rawValue = Number(value);
      } else {
        return;
      }

      if (!isNaN(rawValue)) {
        state.inputs[name] = rawValue;
        if (e.target.type === 'text') {
          e.target.value = rawValue ? rawValue.toLocaleString() : '';
        }
      }
    };

    const handleAddScenario = () => {
      const results = calculateResults(state.inputs, state.calculationMode);
      state.lastCalculatedResults = results;

      const newId = state.scenarios.length > 0 ? Math.max(...state.scenarios.map(s => s.id)) + 1 : 1;
      const newScenario = { id: newId, mode: SIMULATION_MODES.find(m => m.id === state.calculationMode).label, ...results };
      state.scenarios = [...state.scenarios, newScenario];

      updateInputForm();
      renderDashboard();
      renderScenarioTable();
    };

    const handleRemoveScenario = (id) => {
      state.scenarios = state.scenarios.filter(s => s.id !== id);
      renderScenarioTable();
    };

    const handleResetInputs = () => {
      state.inputs = { ...EMPTY_INPUTS };
      state.lastCalculatedResults = calculateResults(EMPTY_INPUTS, 'mode1');
      updateInputForm();
      renderDashboard();
    };

    const handleClearScenarios = () => {
      state.scenarios = [];
      renderScenarioTable();
    };

    window.onload = () => {
      state.domRefs = {
        modeSelectors: document.getElementById('mode-selectors'),
        dashboardCards: document.getElementById('dashboard-cards'),
        dashboardInsightMode: document.getElementById('dashboard-insight-mode'),
        dashboardInsightText: document.getElementById('dashboard-insight-text'),
        scenarioTableBody: document.getElementById('scenario-table-body'),
        addScenarioBtn: document.getElementById('add-scenario-btn'),
        resetInputsBtn: document.getElementById('reset-inputs-btn'),
        headerResetBtn: document.getElementById('header-reset-btn'),
        clearScenariosBtn: document.getElementById('clear-scenarios-btn'),
        excelBtn: document.getElementById('excel-download-btn'),

        // API ìƒíƒœ í‘œì‹œ
        apiStatusBadge: document.getElementById('api-status-badge'),
        apiStatusSub: document.getElementById('api-status-sub'),
        apiRetryBtn: document.getElementById('api-retry-btn'),
      };

      INPUT_FIELDS.forEach(field => {
        const el = document.querySelector(`[name="${field.name}"]`);
        if (el) {
          state.domRefs[`${field.name}Input`] = el;
          el.addEventListener('input', handleInput);
        }
      });

      state.domRefs.addScenarioBtn.addEventListener('click', handleAddScenario);
      state.domRefs.resetInputsBtn.addEventListener('click', handleResetInputs);
      state.domRefs.headerResetBtn.addEventListener('click', handleResetInputs);
      state.domRefs.clearScenariosBtn.addEventListener('click', handleClearScenarios);
      state.domRefs.excelBtn.addEventListener('click', exportScenariosToExcel);
      state.domRefs.apiRetryBtn.addEventListener('click', checkApiConnection);

      document.addEventListener('click', (e) => {
        const modeBtn = e.target.closest('.mode-btn');
        if (modeBtn) setCalculationMode(modeBtn.getAttribute('data-mode'));
        const removeBtn = e.target.closest('.remove-btn');
        if (removeBtn) handleRemoveScenario(Number(removeBtn.getAttribute('data-id')));
      });

      renderModeSelectors();
      updateInputForm();
      renderDashboard();
      renderScenarioTable();

      // âœ… ë¡œë”© ì‹œ API ì—°ê²° í™•ì¸
      checkApiConnection();
    };
  </script>
</head>

<body class="min-h-screen bg-slate-50 font-sans text-slate-900">
  <div id="app-root">
    <!-- Header -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-30">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="bg-blue-600 p-2 rounded-lg">ğŸ§®</div>
          <div>
            <h1 class="text-xl font-bold text-slate-800 tracking-tight">Pro-Consulting Lab</h1>
            <p id="api-status-sub" class="text-[11px] text-slate-500 mt-0.5">ì—°ê²° í™•ì¸ ì „</p>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <!-- âœ… API ì—°ê²°ìƒíƒœ ë°°ì§€ -->
          <div id="api-status-badge" class="text-xs font-semibold px-3 py-1.5 rounded-full border bg-slate-50 text-slate-600 border-slate-200 flex items-center gap-2">
            <span class="inline-block h-2 w-2 rounded-full bg-slate-400"></span> API ëŒ€ê¸°
          </div>

          <button id="api-retry-btn" class="text-xs font-medium bg-white border border-slate-300 px-3 py-1.5 rounded-lg hover:bg-slate-50 transition-colors">
            ğŸ”Œ API ì¬í™•ì¸
          </button>

          <button id="header-reset-btn" class="text-sm text-slate-500 hover:text-slate-800 px-3 py-2 flex items-center gap-1 transition-colors rounded-lg">
            ğŸ”„ ì´ˆê¸°í™”
          </button>
        </div>
      </div>
    </header>

    <main class="max-w-[1800px] mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <section class="mb-8">
        <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">ğŸ’¡ ì‹œë®¬ë ˆì´ì…˜ ê¸°ì¤€ ì„¤ì •</h2>
        <div id="mode-selectors" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4"></div>
      </section>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">
        <div class="lg:col-span-1 bg-white rounded-2xl shadow-xl border border-slate-200 p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="font-bold text-lg text-slate-800">ê¸°ì´ˆ ë°ì´í„° ì…ë ¥</h3>
            <span class="text-xs font-medium px-2 py-1 bg-slate-100 rounded text-slate-500">ë‹¨ìœ„: ì›</span>
          </div>

          <div class="space-y-5" id="input-form">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1.5 flex justify-between">ì—°ë§¤ì¶œ
                <span style="display: none;" class="text-xs text-blue-500 font-normal self-center">ìë™ ì‚°ì¶œë¨</span>
              </label>
              <input type="text" name="annualRevenue" class="w-full px-4 py-2.5 rounded-lg border transition-colors" />
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1.5">ì›”ì§€ì¶œ</label>
              <input type="text" name="monthlyExpense" class="w-full px-4 py-2.5 rounded-lg border transition-colors" />
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1.5 flex justify-between">ì›”í•„ìš”ê²½ë¹„
                <span style="display: none;" class="text-xs text-blue-500 font-normal self-center">ìë™ ì‚°ì¶œë¨</span>
              </label>
              <input type="text" name="monthlyRequiredExpense" class="w-full px-4 py-2.5 rounded-lg border transition-colors" />
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1.5 flex justify-between">ëª©í‘œì†Œë“ë¥  (%)
                <span style="display: none;" class="text-xs text-blue-500 font-normal self-center">ìë™ ì‚°ì¶œë¨</span>
              </label>
              <div class="relative">
                <input type="number" name="targetProfitRate" step="0.1" class="w-full px-4 py-2.5 rounded-lg border transition-colors pr-8" />
                <span class="absolute right-3 top-2.5 text-slate-400">%</span>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1.5 flex justify-between">ì„¸í›„ì›”ìˆœì´ìµ
                <span style="display: none;" class="text-xs text-blue-500 font-normal self-center">ìë™ ì‚°ì¶œë¨</span>
              </label>
              <input type="text" name="afterTaxNetIncome" class="w-full px-4 py-2.5 rounded-lg border transition-colors" />
            </div>

            <div class="grid grid-cols-2 gap-3 mt-8 pt-4 border-t border-slate-100">
              <button id="add-scenario-btn" class="bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-semibold shadow-lg shadow-blue-200 transition-all flex items-center justify-center gap-2 transform hover:scale-[1.02] active:scale-100">ğŸ§® ê³„ì‚°í•˜ê¸°</button>
              <button id="reset-inputs-btn" class="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 py-3 rounded-xl font-semibold transition-all flex items-center justify-center gap-2">ğŸ”„ ì…ë ¥ ì´ˆê¸°í™”</button>
            </div>
          </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
          <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">â¡ï¸ ì‹¤ì‹œê°„ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h3>
          <div id="dashboard-cards" class="space-y-4"></div>

          <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 flex items-start gap-3">
            <div class="p-1 bg-amber-100 rounded text-amber-600 mt-1">ğŸ“ˆ</div>
            <div>
              <h4 class="text-sm font-bold text-amber-800">ì»¨ì„¤íŒ… ì¸ì‚¬ì´íŠ¸ (<span id="dashboard-insight-mode"></span>)</h4>
              <p class="text-sm text-amber-700 mt-1 leading-relaxed" id="dashboard-insight-text"></p>
            </div>
          </div>

          <div class="bg-slate-50 border border-slate-200 rounded-xl p-4 text-sm text-slate-600">
            <div class="font-semibold text-slate-700 mb-1">ìš”ìœ¨/ì„¸ìœ¨ ê¸°ì¤€</div>
            <ul class="list-disc ml-5 space-y-1 text-[13px]">
              <li>êµ­ë¯¼ì—°ê¸ˆ/ê±´ê°•ë³´í—˜ë£Œ: <span class="font-semibold">ì‚¬ì—…ì£¼(2ë°°) + /meta ìƒí•˜í•œ + 10ì› ì ˆì‚¬ ê·œì¹™</span> ë°˜ì˜</li>
              <li>ì¢…í•©ì†Œë“ì„¸Â·ì§€ë°©ì„¸: <span class="font-semibold">ì†Œë“ì„¸ ì‚°ì¶œ Ã— 1.1</span></li>
            </ul>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <div class="p-5 border-b border-slate-200 flex justify-between items-center bg-slate-50/50">
          <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">ğŸ“„ ì‹œë‚˜ë¦¬ì˜¤ ë¹„êµ ë¶„ì„</h3>
          <div class="flex gap-2">
            <button id="excel-download-btn" class="text-xs font-medium bg-white border border-slate-300 px-3 py-1.5 rounded-lg hover:bg-slate-50 transition-colors">Excel ë‹¤ìš´ë¡œë“œ</button>
            <button id="clear-scenarios-btn" class="text-xs font-medium bg-white border border-slate-300 px-3 py-1.5 rounded-lg hover:bg-red-50 transition-colors text-red-500 border-red-200">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>
          </div>
        </div>

        <div class="table-container">
          <table class="w-full text-xs text-left border-collapse">
            <thead class="bg-slate-50 text-slate-600 font-semibold border-b border-slate-200 sticky top-0 z-20">
              <tr>
                <th rowspan="2" class="px-3 py-4 whitespace-nowrap text-center border-r border-slate-200 sticky sticky-col sticky-col-1 bg-slate-50 z-20">No</th>
                <th rowspan="2" class="px-4 py-4 whitespace-nowrap text-center border-r border-slate-200 sticky sticky-col sticky-col-2 bg-slate-50 z-20">êµ¬ë¶„</th>
                <th colspan="2" class="px-2 py-2 whitespace-nowrap text-center border-r border-slate-200 bg-blue-50 text-blue-800">ì†Œë“ë¥ </th>
                <th colspan="2" class="px-2 py-2 whitespace-nowrap text-center border-r border-slate-200 bg-slate-100 text-slate-800">ë§¤ì¶œ</th>
                <th colspan="2" class="px-2 py-2 whitespace-nowrap text-center border-r border-slate-200 bg-slate-100 text-slate-800">ì§€ì¶œ</th>
                <th colspan="2" class="px-2 py-2 whitespace-nowrap text-center border-r border-slate-200 bg-slate-100 text-slate-800">í•„ìš” ê²½ë¹„</th>

                <!-- âœ… ì¶”ê°€: ì†Œë“ê¸ˆì•¡(ì¹´í…Œê³ ë¦¬) -->
                <th colspan="2" class="px-2 py-2 whitespace-nowrap text-center border-r border-slate-200 bg-slate-50 text-slate-800">ì†Œë“ê¸ˆì•¡</th>

                <th colspan="3" class="px-2 py-2 whitespace-nowrap text-center border-r border-slate-200 bg-blue-50 text-blue-800">ì„¸í›„ìˆœì´ìµ</th>
                <th colspan="3" class="px-2 py-2 whitespace-nowrap text-center border-r border-slate-200">ì¢…í•©ì†Œë“ì„¸Â·ì§€ë°©ì„¸</th>
                <th colspan="2" class="px-2 py-2 whitespace-nowrap text-center border-r border-slate-200">êµ­ë¯¼ì—°ê¸ˆ</th>
                <th colspan="2" class="px-2 py-2 whitespace-nowrap text-center border-r border-slate-200">ê±´ê°•ë³´í—˜ë£Œ</th>
                <th rowspan="2" class="px-3 py-4 text-center">ê´€ë¦¬</th>
              </tr>
              <tr class="bg-slate-50/50 text-[11px] text-slate-500">
                <th class="px-4 py-2 text-center border-r border-slate-200 bg-blue-50/50 text-blue-800">ì‹¤ì œ</th>
                <th class="px-4 py-2 text-center border-r border-slate-200 bg-blue-50/50 text-blue-800">ëª©í‘œ</th>

                <th class="px-2 py-2 text-center border-r border-slate-200 bg-slate-100/50 text-slate-800">ì—°ê°„</th>
                <th class="px-2 py-2 text-center border-r border-slate-200 bg-slate-100/50 text-slate-800">ì›”ê°„</th>

                <th class="px-2 py-2 text-center border-r border-slate-200 bg-slate-100/50 text-slate-800">ì—°ê°„</th>
                <th class="px-2 py-2 text-center border-r border-slate-200 bg-slate-100/50 text-slate-800">ì›”ê°„</th>

                <th class="px-2 py-2 text-center border-r border-slate-200 bg-slate-100/50 text-slate-800">ì—°ê°„</th>
                <th class="px-2 py-2 text-center border-r border-slate-200 bg-slate-100/50 text-slate-800">ì›”ê°„</th>

                <!-- âœ… ì†Œë“ê¸ˆì•¡: ì‹¤ì œ/ëª©í‘œ -->
                <th class="px-2 py-2 text-center border-r border-slate-200 bg-slate-50/50 text-slate-800">ì‹¤ì œ</th>
                <th class="px-2 py-2 text-center border-r border-slate-200 bg-slate-50/50 text-slate-800">ëª©í‘œ</th>

                <th class="px-2 py-2 text-center border-r border-slate-200 bg-blue-50/50 text-blue-800">ì—°ê°„</th>
                <th class="px-2 py-2 text-center border-r border-slate-200 bg-blue-50/50 text-blue-800">ì›”ê°„</th>
                <th class="px-2 py-2 text-center border-r border-slate-200 bg-blue-50/50 text-blue-800">ë¹„ìœ¨</th>

                <th class="px-2 py-2 text-center border-r border-slate-200">ì—°ê°„</th>
                <th class="px-2 py-2 text-center border-r border-slate-200">ì›”ê°„</th>
                <th class="px-2 py-2 text-center border-r border-slate-200">ë¹„ìœ¨</th>

                <th class="px-2 py-2 text-center border-r border-slate-200">ì—°ê°„</th>
                <th class="px-2 py-2 text-center border-r border-slate-200">ì›”ê°„</th>

                <th class="px-2 py-2 text-center border-r border-slate-200">ì—°ê°„</th>
                <th class="px-2 py-2 text-center border-r border-slate-200">ì›”ê°„</th>
              </tr>
            </thead>
            <tbody id="scenario-table-body" class="divide-y divide-slate-100"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
</body>
</html>
